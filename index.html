<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Pilot Fasting Tool (Legs)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <style>
        body { touch-action: manipulation; background-color: #0f172a; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
    </style>
</head>
<body class="text-white font-sans h-screen flex flex-col overflow-hidden">

    <div class="p-3 bg-gray-800 border-b border-gray-700 flex justify-between items-center shadow-md z-10">
        <div>
            <h1 class="text-sm font-bold text-gray-200 uppercase tracking-wide">✈️ Iftar Ops</h1>
            <p class="text-[10px] text-gray-500">JAKIM (20°) | Smart Predict</p>
        </div>
        <div class="flex items-center bg-gray-900 rounded-lg p-1 border border-gray-600">
            <button onclick="setMode('GPS')" id="btn-gps" class="px-3 py-1 text-xs font-bold rounded bg-blue-600 text-white transition-all">GPS</button>
            <button onclick="setMode('MANUAL')" id="btn-man" class="px-3 py-1 text-xs font-bold rounded text-gray-400 hover:text-white transition-all">MANUAL</button>
        </div>
    </div>

    <div class="flex-grow overflow-y-auto pb-20">
        
        <div id="main-bg" class="flex flex-col justify-center items-center py-6 px-4 text-center bg-gray-900 transition-colors duration-700 min-h-[35vh]">
            <p class="text-xs uppercase tracking-widest mb-1 opacity-70">Current Status</p>
            <h2 id="status-text" class="text-4xl font-black mb-1">WAITING</h2>
            <p id="sub-text" class="text-sm text-gray-300 mb-4">Initializing...</p>
            
            <div class="grid grid-cols-2 gap-2 w-full max-w-xs">
                <div class="bg-black/30 p-2 rounded border border-white/10">
                    <p class="text-[10px] text-gray-400 uppercase">Altitude</p>
                    <p id="disp-alt" class="text-lg font-mono text-blue-300">---</p>
                </div>
                <div class="bg-black/30 p-2 rounded border border-white/10">
                    <p class="text-[10px] text-gray-400 uppercase">Sun Elev</p>
                    <p id="disp-sun" class="text-lg font-mono text-yellow-300">---</p>
                </div>
            </div>
        </div>

        <div id="input-panel" class="bg-gray-800 p-4 border-t border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-blue-400 uppercase">Current Position</span>
                <span id="mode-badge" class="text-[10px] px-1 rounded bg-green-900 text-green-300">GPS LIVE</span>
            </div>

            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="text" id="inp-lat" class="bg-gray-900 border border-gray-600 p-2 rounded text-sm font-mono uppercase" placeholder="Lat (N03 15)">
                <input type="text" id="inp-lon" class="bg-gray-900 border border-gray-600 p-2 rounded text-sm font-mono uppercase" placeholder="Lon (E101 30)">
            </div>
            
            <div class="grid grid-cols-3 gap-2 mb-3">
                <input type="number" id="inp-alt" class="bg-gray-900 border border-gray-600 p-2 rounded text-sm font-mono" placeholder="Alt (ft)">
                <input type="number" id="inp-spd" class="bg-gray-900 border border-gray-600 p-2 rounded text-sm font-mono" placeholder="GS (kts)">
                <input type="number" id="inp-trk" class="bg-gray-900 border border-gray-600 p-2 rounded text-sm font-mono" placeholder="Trk (deg)">
            </div>

            <button onclick="runManualUpdate()" id="btn-calc" class="w-full bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 rounded text-sm hidden mb-4">
                UPDATE POSITION
            </button>

            <div class="border-t border-gray-700 pt-3 mt-1">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold text-purple-400">PREDICTION SETTINGS (MAX 2 HRS)</h3>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div>
                        <label class="text-[10px] text-gray-500 block">Mins to Turn/Wpt</label>
                        <input type="number" id="inp-time" class="w-full bg-gray-700 text-white p-2 rounded font-mono border border-gray-600 focus:border-purple-500" value="120">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 block">Vertical Spd (fpm)</label>
                        <input type="number" id="inp-vs" class="w-full bg-gray-700 text-white p-2 rounded font-mono border border-gray-600 focus:border-purple-500" placeholder="-1500">
                    </div>
                </div>

                <div class="bg-gray-900 rounded border border-gray-600 p-3 text-center">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] text-gray-500">RESULT</span>
                        <span id="utc-clock" class="text-[10px] font-mono text-gray-400">00:00 Z</span>
                    </div>
                    <div id="pred-result" class="text-xl font-mono font-bold text-white py-1">---</div>
                    <p id="pred-detail" class="text-[10px] text-gray-500">Ready to calculate</p>
                </div>
                
                <button onclick="runPrediction()" class="mt-2 w-full py-2 rounded border border-gray-600 text-xs text-gray-300 hover:bg-gray-800">
                    Run Prediction for Leg
                </button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const JAKIM_FAJR = 20.0;
        const SUN_REFRACT = 0.833;
        const R_EARTH = 6371e3;

        // STATE
        let mode = 'GPS'; 
        let state = { lat: 0, lon: 0, alt: 0, spd: 0, trk: 0, status: 'WAITING' };

        // DOM
        const el = {
            lat: document.getElementById('inp-lat'),
            lon: document.getElementById('inp-lon'),
            alt: document.getElementById('inp-alt'),
            spd: document.getElementById('inp-spd'),
            trk: document.getElementById('inp-trk'),
            time: document.getElementById('inp-time'), // Duration limit
            vs: document.getElementById('inp-vs'),     // Vertical Speed
            badge: document.getElementById('mode-badge'),
            calcBtn: document.getElementById('btn-calc'),
            gpsBtn: document.getElementById('btn-gps'),
            manBtn: document.getElementById('btn-man')
        };

        // --- MATH ---
        function toRad(deg) { return deg * Math.PI / 180; }
        function toDeg(rad) { return rad * 180 / Math.PI; }
        
        function calculateDip(ft) {
            if (ft <= 0) return 0;
            const h = ft * 0.3048; 
            return toDeg(Math.acos(R_EARTH / (R_EARTH + h)));
        }

        function calculateDest(lat, lon, distMeters, bearingDeg) {
            const brng = toRad(bearingDeg);
            const lat1 = toRad(lat);
            const lon1 = toRad(lon);
            const angDist = distMeters / R_EARTH;
            const lat2 = Math.asin(Math.sin(lat1) * Math.cos(angDist) + 
                                   Math.cos(lat1) * Math.sin(angDist) * Math.cos(brng));
            const lon2 = lon1 + Math.atan2(Math.sin(brng) * Math.sin(angDist) * Math.cos(lat1), 
                                           Math.cos(angDist) - Math.sin(lat1) * Math.sin(lat2));
            return [toDeg(lat2), toDeg(lon2)];
        }

        function parseCoord(input) {
            if (!input) return 0;
            let str = input.toString().trim().toUpperCase();
            let multiplier = (str.includes('S') || str.includes('W')) ? -1 : 1;
            let cleanStr = str.replace(/[NSEW]/g, '').trim();
            if (cleanStr.includes(' ')) {
                let parts = cleanStr.split(/\s+/);
                return (parseFloat(parts[0]) + (parseFloat(parts[1]) / 60)) * multiplier;
            }
            return parseFloat(cleanStr) * multiplier;
        }

        // --- UI MODE ---
        function setMode(newMode) {
            mode = newMode;
            if (mode === 'GPS') {
                el.gpsBtn.className = "px-3 py-1 text-xs font-bold rounded bg-blue-600 text-white shadow";
                el.manBtn.className = "px-3 py-1 text-xs font-bold rounded text-gray-400 hover:text-white";
                el.badge.innerText = "GPS LIVE";
                el.badge.className = "text-[10px] px-1 rounded bg-green-900 text-green-300";
                el.calcBtn.classList.add('hidden');
                disableInputs(true);
            } else {
                el.gpsBtn.className = "px-3 py-1 text-xs font-bold rounded text-gray-400 hover:text-white";
                el.manBtn.className = "px-3 py-1 text-xs font-bold rounded bg-blue-600 text-white shadow";
                el.badge.innerText = "MANUAL";
                el.badge.className = "text-[10px] px-1 rounded bg-blue-900 text-blue-300";
                el.calcBtn.classList.remove('hidden');
                disableInputs(false);
            }
        }

        function disableInputs(disabled) {
            // Only disable position inputs, keep Prediction Settings active
            [el.lat, el.lon, el.alt, el.spd, el.trk].forEach(i => {
                i.disabled = disabled;
                i.style.opacity = disabled ? 0.6 : 1;
            });
        }

        function runManualUpdate() {
            state.lat = parseCoord(el.lat.value);
            state.lon = parseCoord(el.lon.value);
            state.alt = parseFloat(el.alt.value) || 0;
            state.spd = parseFloat(el.spd.value) || 0;
            state.trk = parseFloat(el.trk.value) || 0;
            updateDisplay();
            runPrediction();
        }

        // --- CORE STATUS ---
        function updateDisplay() {
            const now = new Date();
            document.getElementById('utc-clock').innerText = 
                now.getUTCHours().toString().padStart(2,'0') + ":" + 
                now.getUTCMinutes().toString().padStart(2,'0') + " Z";

            const sunPos = SunCalc.getPosition(now, state.lat, state.lon);
            const sunDeg = toDeg(sunPos.altitude);
            const dip = calculateDip(state.alt);

            const iftarLim = -(SUN_REFRACT + dip);
            const sahurLim = -(JAKIM_FAJR + dip);

            document.getElementById('disp-alt').innerText = Math.round(state.alt);
            document.getElementById('disp-sun').innerText = sunDeg.toFixed(2) + "°";

            const bg = document.getElementById('main-bg');
            const statusText = document.getElementById('status-text');
            const subText = document.getElementById('sub-text');

            if (sunDeg > iftarLim) {
                state.status = 'DAY';
                bg.className = "flex flex-col justify-center items-center py-6 px-4 text-center bg-red-900 transition-colors duration-500 min-h-[35vh]";
                statusText.innerText = "FASTING";
                subText.innerText = `Sun is ${(sunDeg - iftarLim).toFixed(1)}° above horizon`;
            } else if (sunDeg < sahurLim) {
                state.status = 'NIGHT';
                bg.className = "flex flex-col justify-center items-center py-6 px-4 text-center bg-green-900 transition-colors duration-500 min-h-[35vh]";
                statusText.innerText = "NIGHT";
                subText.innerText = "Safe to eat/drink";
            } else {
                state.status = 'TRANSITION';
                bg.className = "flex flex-col justify-center items-center py-6 px-4 text-center bg-yellow-700 transition-colors duration-500 min-h-[35vh]";
                statusText.innerText = "WARNING";
                subText.innerText = "Twilight Zone";
            }
        }

        // --- PREDICTION ENGINE (WITH LIMITS) ---
        function runPrediction() {
            const resDiv = document.getElementById('pred-result');
            const detDiv = document.getElementById('pred-detail');
            resDiv.innerText = "...";

            // User Inputs for Prediction
            const timeLimitMins = parseInt(el.time.value) || 120; // Default 2 hours
            const verticalSpeed = parseInt(el.vs.value) || 0;     // Default 0 fpm
            
            // Cap at 2 hours (120 mins) as per requirement
            const maxMins = Math.min(timeLimitMins, 120);

            setTimeout(() => {
                let simTime = new Date();
                let simLat = state.lat;
                let simLon = state.lon;
                let simAlt = state.alt;

                const isMoving = state.spd > 10;
                const stepMin = isMoving ? 1 : 1; 
                // Distance per minute
                const metersPerStep = (state.spd * 1852) * (stepMin / 60); 

                let found = false;
                let label = "";

                // Look ahead loop
                for (let i = 0; i <= maxMins; i += stepMin) {
                    
                    // 1. Move Time
                    simTime.setMinutes(simTime.getMinutes() + stepMin);
                    
                    // 2. Move Plane (Horizontal)
                    if (isMoving) {
                        const newPos = calculateDest(simLat, simLon, metersPerStep, state.trk);
                        simLat = newPos[0];
                        simLon = newPos[1];
                    }

                    // 3. Move Plane (Vertical)
                    // If descending (-1500 fpm), alt decreases
                    simAlt += (verticalSpeed * stepMin); 
                    if (simAlt < 0) simAlt = 0;

                    // 4. Calculate Sun with new Alt
                    const dip = calculateDip(simAlt);
                    const iftarLim = -(SUN_REFRACT + dip);
                    const sahurLim = -(JAKIM_FAJR + dip);
                    
                    const sPos = SunCalc.getPosition(simTime, simLat, simLon);
                    const sDeg = toDeg(sPos.altitude);

                    // 5. Check Thresholds
                    if (state.status === 'DAY') {
                        // Looking for IFTAR (Sunset)
                        if (sDeg < iftarLim) {
                            simTime.setMinutes(simTime.getMinutes() + 2); // Safety Buffer
                            label = "IFTAR";
                            found = true;
                            break;
                        }
                    } else {
                        // Looking for SAHUR (Dawn)
                        if (sDeg > sahurLim) {
                            simTime.setMinutes(simTime.getMinutes() - 2); // Safety Buffer
                            label = "SAHUR ENDS";
                            found = true;
                            break;
                        }
                    }
                }

                if (found) {
                    const utc = simTime.getUTCHours().toString().padStart(2,'0') + ":" + 
                                simTime.getUTCMinutes().toString().padStart(2,'0') + " Z";
                    resDiv.innerText = `${label}: ${utc}`;
                    detDiv.innerText = `Event found within ${maxMins} min leg`;
                } else {
                    resDiv.innerText = "NO EVENT";
                    detDiv.innerText = `Status will not change in next ${maxMins} mins on this track.`;
                }
            }, 50);
        }

        // --- GPS ---
        navigator.geolocation.watchPosition(pos => {
            if (mode === 'MANUAL') return;
            state.lat = pos.coords.latitude;
            state.lon = pos.coords.longitude;
            state.alt = pos.coords.altitude ? (pos.coords.altitude * 3.28084) : 0;
            
            // Fill inputs for visual
            el.lat.value = state.lat.toFixed(4);
            el.lon.value = state.lon.toFixed(4);
            el.alt.value = Math.round(state.alt);

            if (pos.coords.speed && pos.coords.speed > 5) {
                state.spd = Math.round(pos.coords.speed * 1.94384);
                el.spd.value = state.spd;
            }
            if (pos.coords.heading) {
                state.trk = Math.round(pos.coords.heading);
                el.trk.value = state.trk;
            }
            updateDisplay();
        }, err => console.log(err), { enableHighAccuracy: true });

        setInterval(updateDisplay, 1000);
        disableInputs(true);

    </script>
</body>
</html>
